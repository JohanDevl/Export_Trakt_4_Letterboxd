name: ðŸ”’ Security Scanning

on:
  push:
    branches: [main, develop, feature/enhanced-security-18]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  gosec-scan:
    name: ðŸ” Static Security Analysis (gosec)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Download dependencies
        run: go mod download

      - name: Run gosec security scanner
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec -fmt sarif -out gosec-results.sarif ./...

      - name: Upload gosec results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif

      - name: Upload gosec results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gosec-results
          path: gosec-results.sarif

  dependency-scan:
    name: ðŸ”’ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govulncheck-results.json || true

      - name: Upload vulnerability scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: govulncheck-results.json

      - name: Check for critical vulnerabilities
        run: |
          if grep -q '"severity": "HIGH"' govulncheck-results.json || grep -q '"severity": "CRITICAL"' govulncheck-results.json; then
            echo "âŒ Critical or high severity vulnerabilities found!"
            echo "Please review and update dependencies."
            exit 1
          else
            echo "âœ… No critical vulnerabilities found."
          fi

  docker-security-scan:
    name: ðŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build secure Docker image
        run: |
          docker build -t export-trakt:security-test -f Dockerfile.secure .

      - name: Install Trivy scanner
        run: |
          sudo apt-get update
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Run Trivy vulnerability scanner
        run: |
          trivy image --format sarif --output trivy-results.sarif export-trakt:security-test

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Run Docker best practices scan
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$(pwd)":/workspace \
            goodwithtech/dockle:latest \
            --format json \
            --output dockle-results.json \
            export-trakt:security-test || true

      - name: Upload Docker security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-security-results
          path: |
            trivy-results.sarif
            dockle-results.json

  codeql-analysis:
    name: ðŸ•µï¸ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["go"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  security-audit:
    name: ðŸ” Security Configuration Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Build application
        run: go build -o export-trakt ./cmd/export_trakt

      - name: Create test configuration
        run: |
          mkdir -p config
          cp config/config.example.toml config/config.toml
          # Set secure defaults for testing
          sed -i 's/encryption_enabled = true/encryption_enabled = true/' config/config.toml
          sed -i 's/audit_logging = true/audit_logging = true/' config/config.toml
          sed -i 's/require_https = true/require_https = true/' config/config.toml

      - name: Run security configuration validation
        run: |
          # Test with secure configuration
          ./export-trakt --config=config/config.toml --validate-security || true

      - name: Check file permissions
        run: |
          echo "ðŸ” Checking file permissions..."

          # Check that sensitive files have restrictive permissions
          if [ -f "config/config.toml" ]; then
            perms=$(stat -c "%a" config/config.toml)
            if [ "$perms" != "600" ] && [ "$perms" != "644" ]; then
              echo "âš ï¸  Config file permissions are too permissive: $perms"
            else
              echo "âœ… Config file permissions are secure: $perms"
            fi
          fi

          # Check Dockerfile security
          echo "ðŸ” Checking Dockerfile security..."
          if grep -q "USER.*root" Dockerfile.secure; then
            echo "âŒ Dockerfile.secure contains root user usage"
            exit 1
          else
            echo "âœ… Dockerfile.secure uses non-root user"
          fi

      - name: Security checklist validation
        run: |
          echo "ðŸ”’ Security Checklist Validation"
          echo "================================"

          checklist_items=(
            "AES encryption implementation:pkg/security/encryption"
            "Keyring integration:pkg/security/keyring" 
            "Audit logging:pkg/security/audit"
            "Rate limiting:pkg/security/ratelimit.go"
            "HTTPS enforcement:pkg/security/https.go"
            "Input validation:pkg/security/validation"
            "Secure Docker image:Dockerfile.secure"
            "Security configuration:pkg/security/config.go"
          )

          failed_items=0
          for item in "${checklist_items[@]}"; do
            name=$(echo "$item" | cut -d: -f1)
            path=$(echo "$item" | cut -d: -f2)
            if [ -e "$path" ]; then
              echo "âœ… $name"
            else
              echo "âŒ $name (missing: $path)"
              failed_items=$((failed_items + 1))
            fi
          done

          if [ $failed_items -gt 0 ]; then
            echo "âŒ Security checklist validation failed: $failed_items missing items"
            exit 1
          else
            echo "âœ… All security features implemented"
          fi

  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        gosec-scan,
        dependency-scan,
        docker-security-scan,
        codeql-analysis,
        security-audit,
      ]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-results

      - name: Generate security summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md

          # Check each job status
          if [ "${{ needs.gosec-scan.result }}" = "success" ]; then
            echo "âœ… **Static Analysis (gosec)**: Passed" >> security-summary.md
          else
            echo "âŒ **Static Analysis (gosec)**: Failed" >> security-summary.md
          fi

          if [ "${{ needs.dependency-scan.result }}" = "success" ]; then
            echo "âœ… **Dependency Scan**: Passed" >> security-summary.md
          else
            echo "âŒ **Dependency Scan**: Failed" >> security-summary.md
          fi

          if [ "${{ needs.docker-security-scan.result }}" = "success" ]; then
            echo "âœ… **Docker Security**: Passed" >> security-summary.md
          else
            echo "âŒ **Docker Security**: Failed" >> security-summary.md
          fi

          if [ "${{ needs.codeql-analysis.result }}" = "success" ]; then
            echo "âœ… **CodeQL Analysis**: Passed" >> security-summary.md
          else
            echo "âŒ **CodeQL Analysis**: Failed" >> security-summary.md
          fi

          if [ "${{ needs.security-audit.result }}" = "success" ]; then
            echo "âœ… **Security Audit**: Passed" >> security-summary.md
          else
            echo "âŒ **Security Audit**: Failed" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "## Security Features Status" >> security-summary.md
          echo "" >> security-summary.md
          echo "- ðŸ” **Credential Management**: AES-256 encryption, keyring integration" >> security-summary.md
          echo "- ðŸ›¡ï¸ **Data Protection**: File permissions, input validation, secure temp files" >> security-summary.md
          echo "- ðŸŒ **Network Security**: HTTPS enforcement, secure HTTP client" >> security-summary.md
          echo "- ðŸš¦ **Rate Limiting**: Token bucket algorithm, per-service limits" >> security-summary.md
          echo "- ðŸ“ **Audit Logging**: Structured JSON logging, security events" >> security-summary.md
          echo "- ðŸ³ **Container Security**: Non-root user, distroless image, minimal permissions" >> security-summary.md
          echo "- ðŸ” **Static Analysis**: gosec, CodeQL, dependency scanning" >> security-summary.md

          cat security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: Comment security summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
