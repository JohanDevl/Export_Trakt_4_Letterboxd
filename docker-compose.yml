version: "3.8"

services:
  # Base service configuration (not started directly)
  export-trakt-base: &export-trakt-base
    image: johandevl/export-trakt-4-letterboxd:latest
    container_name: export-trakt
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./exports:/app/exports
    restart: "no"
    environment:
      - TZ=UTC

  # Normal export (default)
  export-trakt:
    <<: *export-trakt-base
    profiles: ["default", "export"]
    command: ["export", "--mode", "normal"]

  # Interactive setup
  export-trakt-setup:
    <<: *export-trakt-base
    profiles: ["setup"]
    command: ["setup"]
    # Interactive TTY for setup process
    tty: true
    stdin_open: true

  # Complete export
  export-trakt-complete:
    <<: *export-trakt-base
    profiles: ["complete"]
    command: ["export", "--mode", "complete"]

  # Initial export
  export-trakt-initial:
    <<: *export-trakt-base
    profiles: ["initial"]
    command: ["export", "--mode", "initial"]

  # Validate configuration
  export-trakt-validate:
    <<: *export-trakt-base
    profiles: ["validate"]
    command: ["validate"]

  # Scheduled export (runs as cron job)
  export-trakt-scheduled:
    <<: *export-trakt-base
    profiles: ["scheduled"]
    image: johandevl/export-trakt-4-letterboxd:latest
    restart: unless-stopped
    # This entrypoint overrides the default to run as a cron job
    entrypoint: ["/bin/sh", "-c"]
    # Run every day at 2 AM
    command: >
      "
      echo \"$$EXPORT_SCHEDULE\" > /tmp/crontab &&
      echo \"# Run Export Trakt for Letterboxd\" >> /tmp/crontab &&
      echo \"$$EXPORT_SCHEDULE /app/export-trakt export >> /app/logs/cron.log 2>&1\" >> /tmp/crontab &&
      crond -f -d 8 -c /tmp
      "
    environment:
      - TZ=UTC
      - EXPORT_SCHEDULE=0 2 * * * # Run every day at 2 AM

# Docker Compose usage examples:
#
# Default export (normal mode):
# docker-compose up
#
# Interactive setup:
# docker-compose --profile setup up
#
# Complete export:
# docker-compose --profile complete up
#
# Initial export:
# docker-compose --profile initial up
#
# Validate configuration:
# docker-compose --profile validate up
#
# Scheduled export (runs as cron job):
# docker-compose --profile scheduled up -d

volumes:
  trakt_logs:
  trakt_copy:
  trakt_backup:
